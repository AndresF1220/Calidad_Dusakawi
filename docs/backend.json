{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the Atlas SGI application.",
      "properties": {
        "fullName": {
          "type": "string",
          "description": "The user's full name."
        },
        "cedula": {
          "type": "string",
          "description": "The user's national ID number."
        },
        "email": {
          "type": "string",
          "description": "The user's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The user's role (e.g., superadmin, admin, viewer).",
          "enum": [
            "superadmin",
            "admin",
            "viewer"
          ]
        },
        "status": {
          "type": "string",
          "description": "The user's account status.",
          "enum": [
            "active",
            "inactive"
          ]
        },
        "tempPassword": {
          "type": "string",
          "description": "A temporary password for the user, visible to superadmins."
        },
        "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp of when the user was created."
        }
      },
      "required": [
        "fullName",
        "cedula",
        "email",
        "role",
        "status",
        "tempPassword"
      ]
    },
    "QualityMetric": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QualityMetric",
      "type": "object",
      "description": "Represents a quality metric tracked within the Atlas SGI application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QualityMetric entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the quality metric (e.g., Defect Rate, Customer Satisfaction)."
        },
        "description": {
          "type": "string",
          "description": "A detailed description of the quality metric."
        },
        "targetValue": {
          "type": "number",
          "description": "The target value for the quality metric."
        },
        "unitOfMeasure": {
          "type": "string",
          "description": "The unit of measure for the quality metric (e.g., %, ppm)."
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "targetValue",
        "unitOfMeasure"
      ]
    },
    "QualityDataPoint": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "QualityDataPoint",
      "type": "object",
      "description": "Represents a single data point for a quality metric at a specific point in time.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the QualityDataPoint entity."
        },
        "metricId": {
          "type": "string",
          "description": "Reference to QualityMetric. (Relationship: QualityMetric 1:N QualityDataPoint)"
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp when the data point was recorded.",
          "format": "date-time"
        },
        "value": {
          "type": "number",
          "description": "The value of the quality metric at the given timestamp."
        },
        "source": {
          "type": "string",
          "description": "The source of the data (e.g., manual entry, automated system)."
        }
      },
      "required": [
        "id",
        "metricId",
        "timestamp",
        "value",
        "source"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents a configured alert for a specific quality metric.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Alert entity."
        },
        "metricId": {
          "type": "string",
          "description": "Reference to QualityMetric. (Relationship: QualityMetric 1:N Alert)"
        },
        "threshold": {
          "type": "number",
          "description": "The threshold value that triggers the alert."
        },
        "operator": {
          "type": "string",
          "description": "The operator used to compare the metric value to the threshold (e.g., >, <, =)."
        },
        "message": {
          "type": "string",
          "description": "The message displayed when the alert is triggered."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Alert)"
        },
        "enabled": {
          "type": "boolean",
          "description": "Indicates whether the alert is currently enabled."
        }
      },
      "required": [
        "id",
        "metricId",
        "threshold",
        "operator",
        "message",
        "userId",
        "enabled"
      ]
    },
    "Feedback": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Feedback",
      "type": "object",
      "description": "Represents user feedback on a specific KPI or aspect of the application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Feedback entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Feedback)"
        },
        "timestamp": {
          "type": "string",
          "description": "The timestamp when the feedback was submitted.",
          "format": "date-time"
        },
        "comment": {
          "type": "string",
          "description": "The user's feedback comment."
        },
        "rating": {
          "type": "number",
          "description": "A rating provided by the user (e.g., on a scale of 1-5)."
        }
      },
      "required": [
        "id",
        "userId",
        "timestamp",
        "comment",
        "rating"
      ]
    },
    "AppSettings": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AppSettings",
      "type": "object",
      "description": "Stores global application settings and branding information.",
      "properties": {
        "appName": {
          "type": "string",
          "description": "The name of the application, displayed in the UI."
        },
        "companyName": {
          "type": "string",
          "description": "The name of the company using the application."
        }
      },
      "required": [
        "appName",
        "companyName"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/entities/User"
          },
          "description": "Stores user profiles. Path-based ownership ensures only the user or an admin can access the profile.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/qualityMetrics/{qualityMetricId}",
        "definition": {
          "entityName": "QualityMetric",
          "schema": {
            "$ref": "#/entities/QualityMetric"
          },
          "description": "Stores definitions of quality metrics tracked in the application.",
          "params": [
            {
              "name": "qualityMetricId",
              "description": "The unique identifier of the quality metric."
            }
          ]
        }
      },
      {
        "path": "/qualityMetrics/{qualityMetricId}/dataPoints/{dataPointId}",
        "definition": {
          "entityName": "QualityDataPoint",
          "schema": {
            "$ref": "#/entities/QualityDataPoint"
          },
          "description": "Stores individual data points for a specific quality metric. Includes denormalized 'qualityMetricId' for efficient querying.",
          "params": [
            {
              "name": "qualityMetricId",
              "description": "The unique identifier of the quality metric."
            },
            {
              "name": "dataPointId",
              "description": "The unique identifier of the data point."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": {
            "$ref": "#/entities/Alert"
          },
          "description": "Stores alerts configured by users. Path-based ownership ensures only the user or an admin can manage their alerts.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "alertId",
              "description": "The unique identifier of the alert."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/feedback/{feedbackId}",
        "definition": {
          "entityName": "Feedback",
          "schema": {
            "$ref": "#/entities/Feedback"
          },
          "description": "Stores user feedback. Path-based ownership ensures only the user or an admin can access their feedback.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "feedbackId",
              "description": "The unique identifier of the feedback entry."
            }
          ]
        }
      },
      {
        "path": "/settings/app",
        "definition": {
          "entityName": "AppSettings",
          "schema": {
            "$ref": "#/entities/AppSettings"
          },
          "description": "Stores global application settings and branding. This is a single document."
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the Atlas SGI application, focusing on secure, scalable, and maintainable data management. The structure emphasizes authorization independence, clarity, and predictability.\n\n**Authorization Independence:**\nTo avoid hierarchical authorization dependencies and enable atomic operations, the design uses denormalization. For example, if `QualityDataPoint` access depends on `QualityMetric` attributes, relevant `QualityMetric` attributes (e.g., `ownerId`, `members`) are copied into each `QualityDataPoint` document.\n\n**Structural Segregation:**\nThe data is segregated into collections based on their security postures. User-specific data is stored under `/users/{userId}`, while global data like quality metrics and app settings are stored at the root level. This approach simplifies security rules by ensuring that all documents within a collection share the same access requirements.\n\n**Access Modeling:**\n*   **Private Data:** User-specific data (e.g., alerts, feedback) is stored under `/users/{userId}` to ensure path-based ownership.\n*   **Collaborative Data:**  Currently, there is no collaborative entity, but if there was (e.g. shared dashboards) the `members` map (`members: {uid1: \"role\", uid2: \"role\"}`) would be used.\n*   **Global Data:** The `/settings/app` document is global and readable by all authenticated users.\n\n**QAPs (Rules are not Filters):**\nThe structure supports secure `list` operations by ensuring that collections do not contain mixed data with different access requirements. Path-based ownership and membership maps enable efficient filtering based on user ID or role, so rules do not act as filters. For example, listing `QualityDataPoint` documents under `/qualityMetrics/{qualityMetricId}/dataPoints` will only return data points associated with a specific quality metric, preventing unauthorized access to other metrics' data.\n\n**Data Clarity and Predictability:**\n*   **Explicit State Modeling:** While the schemas don't explicitly define states, adding a `status` field to entities like alerts or quality metrics can help manage workflows (e.g., `DRAFT`, `ACTIVE`, `ARCHIVED`).\n*   **Predictable Schema:** The design avoids dynamic keys by using static keys in objects and arrays where needed.\n*   **Radical Consistency:** Semantic naming conventions are applied throughout the structure to enhance readability and maintainability."
  }
}
